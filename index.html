<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBSERVA+ | Observación Preventiva</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f6f5c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fb; color: #333; }
        .splash { background: linear-gradient(135deg, #0b3c5d, #1f6f5c); color: white; padding: 40px 20px; text-align: center; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .splash h1 { font-size: 3em; margin: 20px 0; }
        .splash p { font-size: 1.1em; margin: 10px 0 30px; opacity: 0.9; }
        .splash button { background: white; color: #1f6f5c; font-weight: 700; padding: 14px 28px; border: none; border-radius: 50px; cursor: pointer; font-size: 1.1em; margin-top: 20px; }
        .splash button:hover { filter: brightness(0.9); }
        header { background: linear-gradient(135deg, #0b3c5d, #1f6f5c); color: white; padding: 18px; text-align: center; display: none; }
        header.visible { display: block; }
        main { padding: 20px; max-width: 980px; margin: auto; display: none; }
        main.visible { display: block; }
        .card { background: white; border-radius: 14px; padding: 18px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { margin: 0 0 20px 0; color: #1f6f5c; }
        label { display: block; margin: 15px 0 5px 0; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 10px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; }
        textarea { resize: vertical; min-height: 80px; }
        button { background: linear-gradient(135deg, #1f6f5c, #f2a365); color: white; font-weight: 700; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; margin: 10px 5px 10px 0; }
        button:hover { filter: brightness(0.95); }
        #preview-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin: 15px 0; }
        .preview-item { position: relative; border-radius: 8px; overflow: hidden; background: #e0e0e0; height: 120px; }
        .preview-item img, .preview-item video { width: 100%; height: 100%; object-fit: cover; }
        .remove-btn { position: absolute; top: 2px; right: 2px; background: rgba(255,0,0,0.9); color: white; border: none; border-radius: 50%; width: 18px; height: 18px; padding: 0; cursor: pointer; font-weight: bold; font-size: 12px; line-height: 18px; text-align: center; }
        #cameraModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: black; display: none; z-index: 1000; align-items: center; justify-content: center; flex-direction: column; }
        #cameraModal.visible { display: flex; }
    </style>
</head>
<body>
    <div class="splash" id="splash">
        <h1>OBSERVA+</h1>
        <p>Sistema de Observación Preventiva</p>
        <button onclick="comenzar()">Comenzar</button>
    </div>

    <header id="header">
        <h1>OBSERVA+ - Reporte</h1>
    </header>

    <main id="main">
        <div class="card">
            <h2>Diligencie el Formulario</h2>
            <form id="reportForm" onsubmit="return validarFormulario()">
                <label for="edificio">Edificio *</label>
                <select id="edificio" required>
                    <option value="">Seleccione...</option>
                    <option>Edificio A</option>
                    <option>Edificio B</option>
                    <option>Edificio C</option>
                </select>

                <label for="lugar">Lugar específ ico *</label>
                <input type="text" id="lugar" placeholder="Ej. Pasillo técnico, laboratorio" required>

                <label for="tipo">Tipo de novedad *</label>
                <select id="tipo" required>
                    <option value="">Seleccione...</option>
                    <option>Acoso</option>
                    <option>Hurto</option>
                    <option>Vandal ismo</option>
                    <option>Otro</option>
                </select>

                <label for="descripcion">Descripción *</label>
                <textarea id="descripcion" placeholder="Describa de forma objetiva lo observado" required></textarea>

                <label for="riesgo">Nivel de riesgo *</label>
                <select id="riesgo" required>
                    <option value="">Seleccione...</option>
                    <option>Bajo</option>
                    <option>Medio</option>
                    <option>Alto</option>
                </select>

                <label>Adjuntar fotos/videos</label>
                <input type="file" id="fileInput" accept="image/*,video/*" multiple onchange="agregarArchivo(event)">
                <button type="button" onclick="abrirCamara()">Capturar Foto</button>
                <button type="button" onclick="abrirGrabadora()">Grabar Video</button>

                <div id="preview-container"></div>

                <button type="button" onclick="cerrarFormulario()">Cerrar</button>
                <button type="submit">Enviar Formulario</button>
            </form>
        </div>
    </main>

    <div id="cameraModal">
        <video id="video" style="width: 100%; max-width: 500px; margin: 10px;"></video>
        <canvas id="canvas" style="display: none;"></canvas>
        <div style="margin: 10px;">
            <button onclick="tomarFoto()">Capturar</button>
            <button onclick="cerrarCamara()" style="background: #999;">Cerrar</button>
        </div>
    </div>

    <script>
        let stream = null;
        let archivos = [];
        let modoVideo = false;

        function comenzar() {
            document.getElementById('splash').style.display = 'none';
            document.getElementById('header').classList.add('visible');
            document.getElementById('main').classList.add('visible');
        }

        function cerrarFormulario() {
            document.getElementById('splash').style.display = 'flex';
            document.getElementById('header').classList.remove('visible');
            document.getElementById('main').classList.remove('visible');
            document.getElementById('reportForm').reset();
            archivos = [];
            actualizarPreview();
        }

        function validarFormulario() {
            const edificio = document.getElementById('edificio').value;
            const lugar = document.getElementById('lugar').value;
            const tipo = document.getElementById('tipo').value;
            const descripcion = document.getElementById('descripcion').value;
            const riesgo = document.getElementById('riesgo').value;

            if (!edificio || !lugar || !tipo || !descripcion || !riesgo) {
                alert('Por favor, complete todos los campos obligatorios.');
                return false;
            }
            return true;
        }

        function abrirCamara() {
            modoVideo = false;
            document.getElementById('cameraModal').classList.add('visible');
            navigator.mediaDevices.getUserMedia({ video: true }).then(s => {
                stream = s;
                document.getElementById('video').srcObject = s;
            }).catch(e => alert('Error: ' + e.message));
        }

        function abrirGrabadora() {
            modoVideo = true;
            document.getElementById('cameraModal').classList.add('visible');
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
                stream = s;
                document.getElementById('video').srcObject = s;
            }).catch(e => alert('Error: ' + e.message));
        }

        function tomarFoto() {
            if (modoVideo) {
                grabarVideo();
            } else {
                const canvas = document.getElementById('canvas');
                const video = document.getElementById('video');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                canvas.toBlob(blob => {
                    archivos.push(blob);
                    actualizarPreview();
                    cerrarCamara();
                });
            }
        }

        function grabarVideo() {
            const mediaRecorder = new MediaRecorder(stream);
            const chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                archivos.push(blob);
                actualizarPreview();
                cerrarCamara();
            };
            mediaRecorder.start();
            setTimeout(() => mediaRecorder.stop(), 5000);
        }

        function cerrarCamara() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            document.getElementById('cameraModal').classList.remove('visible');
            document.getElementById('video').srcObject = null;
        }

        function agregarArchivo(event) {
            const files = event.target.files;
            for (let file of files) {
                archivos.push(file);
            }
            actualizarPreview();
        }

        function actualizarPreview() {
            const container = document.getElementById('preview-container');
            container.innerHTML = '';
            archivos.forEach((archivo, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                const isVideo = archivo.type.startsWith('video/');
                const src = URL.createObjectURL(archivo);
                if (isVideo) {
                    const video = document.createElement('video');
                    video.src = src;
                    video.controls = false;
                    div.appendChild(video);
                } else {
                    const img = document.createElement('img');
                    img.src = src;
                    div.appendChild(img);
                }
                const btn = document.createElement('button');
                btn.className = 'remove-btn';
                btn.textContent = 'X';
                btn.onclick = () => {
                    archivos.splice(index, 1);
                    actualizarPreview();
                };
                div.appendChild(btn);
                container.appendChild(div);
            });
        }

        function enviarCorreo() {
            if (!validarFormulario()) return;
            const fecha = document.getElementById('fecha').value;
            const edificio = document.getElementById('edificio').value;
            const tipo = document.getElementById('tipo').value;
            const descripcion = document.getElementById('descripcion').value;
            const texto = `REPORTE OBSERVA+\n\nFecha: ${fecha}\nEdificio: ${edificio}\nTipo: ${tipo}\nDescripción: ${descripcion}\n\nAdjunto evidencias visuales`;
            const body = encodeURIComponent(texto);
            window.location.href = `mailto:paeto@tgrupo.com?subject=Reporte%20OBSERVA%2B&body=${body}`;
        }

        function enviarWhatsApp() {
            if (!validarFormulario()) return;
            const fecha = document.getElementById('fecha').value;
            const edificio = document.getElementById('edificio').value;
            const tipo = document.getElementById('tipo').value;
            const descripcion = document.getElementById('descripcion').value;
            let mensaje = `*REPORTE OBSERVA+*\n\n*Fecha:* ${fecha}\n*Edificio:* ${edificio}\n*Tipo:* ${tipo}\n*Descripción:* ${descripcion}`;
            
            if (archivos.length > 0) {
                mensaje += `\n\n*Evidencias adjuntas:* ${archivos.length} archivo(s)`;
            }
            
            const texto = encodeURIComponent(mensaje);
            window.open(`https://wa.me/?text=${texto}`, '_blank');
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
